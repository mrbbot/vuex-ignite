{"version":3,"file":"vuex-ignite.js","sources":["../src/main.js"],"sourcesContent":["const isFunction = (obj) => !!(obj && obj.constructor && obj.call && obj.apply);\r\nconst isPrimitive = (obj) => obj !== Object(obj);\r\nconst defaultValue = (type) => {\r\n    switch(type) {\r\n        case Boolean:   return false;\r\n        case Number:    return 0;\r\n        case Object:    return null;\r\n        case String:    return \"\";\r\n        case Array:     return null;\r\n        default:        return void 0;\r\n    }\r\n};\r\n\r\nconst NAMESPACE = \"firebase\";\r\nconst FIREBASE_SET = `${NAMESPACE}/SET`;\r\nconst FIREBASE_LIST_INIT = `${NAMESPACE}/LIST_INIT`;\r\nconst FIREBASE_LIST_ADD = `${NAMESPACE}/LIST_ADD`;\r\nconst FIREBASE_LIST_CHANGE = `${NAMESPACE}/LIST_CHANGE`;\r\nconst FIREBASE_LIST_REMOVE = `${NAMESPACE}/LIST_REMOVE`;\r\nconst FIREBASE_LIST_MOVE = `${NAMESPACE}/LIST_MOVE`;\r\nconst FIREBASE_ACTION = `${NAMESPACE}/ACTION`;\r\n\r\nexport function ignite(storeOptions) {\r\n    storeOptions = Object.assign({\r\n        state: {},\r\n        mutations: {},\r\n        actions: {},\r\n        plugins: []\r\n    }, storeOptions);\r\n\r\n    let authBinding;\r\n    let normalisedBindings = [];\r\n    for(let binding in storeOptions.firebase) {\r\n        const bindingObject = storeOptions.firebase[binding];\r\n        const ref = (bindingObject.constructor.name === 'Query' ? undefined : bindingObject.ref) || bindingObject;\r\n        const refName = ref.constructor.name;\r\n        if(refName === 'Reference' || refName === 'Function' || refName === 'Query') {\r\n            const type = bindingObject.type || Array;\r\n            storeOptions.state[binding] = defaultValue(type);\r\n            normalisedBindings.push({\r\n                name: binding,\r\n                ref: ref,\r\n                type: type\r\n            });\r\n        } else {\r\n            storeOptions.state[binding] = false;\r\n            authBinding = {\r\n                name: binding,\r\n                auth: ref\r\n            };\r\n        }\r\n    }\r\n\r\n    storeOptions.mutations[FIREBASE_LIST_INIT] = (state, { key } ) => state[key] = [];\r\n    storeOptions.mutations[FIREBASE_SET] = (state, { key, value }) => state[key] = value;\r\n    storeOptions.mutations[FIREBASE_LIST_ADD] = (state, { key, value }) => state[key] = [...state[key], value];\r\n    storeOptions.mutations[FIREBASE_LIST_CHANGE] = (state, { key, value }) => {\r\n        const index = state[key].findIndex(v => v['.key'] === value['.key']);\r\n        state[key] = [...state[key]];\r\n        state[key].splice(index, 1, value);\r\n    };\r\n    storeOptions.mutations[FIREBASE_LIST_REMOVE] = (state, { key, listKey }) =>\r\n        state[key] = state[key].filter(v => v['.key'] !== listKey);\r\n    storeOptions.mutations[FIREBASE_LIST_MOVE] = (state, { key, listKey, prevListKey }) => {\r\n        const currentIndex = state[key].findIndex(v => v['.key'] === listKey);\r\n        const newPreviousIndex = prevListKey !== null ? state[key].findIndex(v => v['.key'] === prevListKey) : 0;\r\n        state[key] = [...state[key]];\r\n        state[key].splice(newPreviousIndex, 0, state[key].splice(currentIndex, 1)[0]);\r\n    };\r\n\r\n    storeOptions.actions[FIREBASE_ACTION] = ({ commit }, { authBinding, normalisedBindings, store }) => {\r\n        const bind = (type, ref, name) => {\r\n            store.$firebaseRefs[name] = ref.ref || ref;\r\n            if(type === Array) {\r\n                ref.once('value', () => {\r\n                    commit(FIREBASE_LIST_INIT, {\r\n                        key: name\r\n                    });\r\n\r\n                    ref.on('child_added', data => {\r\n                        const val = data.val();\r\n                        commit(FIREBASE_LIST_ADD, {\r\n                            key: name,\r\n                            value: {\r\n                                '.key': data.key,\r\n                                ...(isPrimitive(val) ? { '.value': val } : val)\r\n                            }\r\n                        });\r\n                    });\r\n                    ref.on('child_changed', data => {\r\n                        const val = data.val();\r\n                        commit(FIREBASE_LIST_CHANGE, {\r\n                            key: name,\r\n                            value: {\r\n                                '.key': data.key,\r\n                                ...(isPrimitive(val) ? { '.value': val } : val)\r\n                            }\r\n                        })\r\n                    });\r\n                    ref.on('child_removed', data => commit(FIREBASE_LIST_REMOVE, {\r\n                        key: name,\r\n                        listKey: data.key\r\n                    }));\r\n                    ref.on('child_moved', (data, prevKey) => commit(FIREBASE_LIST_MOVE, {\r\n                        key: name,\r\n                        listKey: data.key,\r\n                        prevListKey: prevKey\r\n                    }));\r\n                });\r\n            } else {\r\n                ref.on('value', data => commit(FIREBASE_SET, {\r\n                    key: name,\r\n                    value: data.val()\r\n                }));\r\n            }\r\n        };\r\n\r\n        const functionalBindings = [];\r\n        for(let binding of normalisedBindings) {\r\n            if(isFunction(binding.ref)) functionalBindings.push(binding);\r\n            else bind(binding.type, binding.ref, binding.name);\r\n        }\r\n\r\n        if(authBinding) {\r\n            // noinspection JSUnresolvedFunction\r\n            authBinding.auth.onAuthStateChanged(user => {\r\n                for(let functionalBinding of functionalBindings) {\r\n                    if(functionalBinding.currentRef) functionalBinding.currentRef.off();\r\n                    if(store.$firebaseRefs[functionalBinding.name]) delete store.$firebaseRefs[functionalBinding.name];\r\n\r\n                    if(!user) {\r\n                        commit(FIREBASE_SET, {\r\n                            key: functionalBinding.name,\r\n                            value: defaultValue(functionalBinding.type)\r\n                        });\r\n                    } else {\r\n                        const ref = functionalBinding.ref(user);\r\n                        functionalBinding.currentRef = ref;\r\n                        bind(functionalBinding.type, ref, functionalBinding.name);\r\n                    }\r\n                }\r\n\r\n                commit(FIREBASE_SET, {\r\n                    key: authBinding.name,\r\n                    value: user\r\n                });\r\n            });\r\n        }\r\n    };\r\n\r\n    storeOptions.plugins.push((store) => {\r\n        store.$firebaseRefs = {};\r\n        // noinspection JSIgnoredPromiseFromCall\r\n        store.dispatch(FIREBASE_ACTION, { authBinding, normalisedBindings, store });\r\n    });\r\n\r\n    return storeOptions;\r\n}"],"names":["const","isFunction","obj","constructor","call","apply","isPrimitive","Object","defaultValue","type","Boolean","Number","String","Array","FIREBASE_SET","NAMESPACE","FIREBASE_LIST_INIT","FIREBASE_LIST_ADD","FIREBASE_LIST_CHANGE","FIREBASE_LIST_REMOVE","FIREBASE_LIST_MOVE","FIREBASE_ACTION","storeOptions","let","authBinding","assign","state","mutations","actions","plugins","normalisedBindings","binding","firebase","bindingObject","ref","name","undefined","refName","push","auth","key","value","index","findIndex","v","splice","listKey","filter","prevListKey","currentIndex","newPreviousIndex","ref$1","commit","store","bind","$firebaseRefs","once","on","data","val",".key",".value","prevKey","functionalBindings","onAuthStateChanged","user","functionalBinding","currentRef","off","dispatch"],"mappings":"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"}